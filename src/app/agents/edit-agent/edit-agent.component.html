<!-- Header -->
<app-page-title [title]="'Agent Details'" [subbutton]="false"></app-page-title>
<!-- Body -->
<grid-main [class]="'width:100%'">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="row g-3">
      <div class="col-md-2">
        <grid-form-input [name]="'Agent ID'">
          <div class="input-group">
            <span class="pre input-group-text input-group-lg">
              {{ agent._id }}
            </span>
          </div>
        </grid-form-input>
      </div>
      <div class="col-md-10">
        <grid-form-input [name]="'Last activity'" [additionalClasses]="['last']">
          <div class="agent-last-activity">
            <span>Time:</span>{{ agent.lastTime | uiDate }}<br>
            <span>Action:</span>{{ agent.lastAct }}<br>
            <span>IP:</span><code>{{ agent.lastIp }}</code>
          </div>
        </grid-form-input>
      </div>
    </div>
    <ngb-accordion #acc="ngbAccordion">
      <ngb-panel>
        <ng-template ngbPanelTitle>
          <span><b>Show/Hide details</b></span>
        </ng-template>
        <ng-template ngbPanelContent let-form="form">
          <div class="row">
            <div class="col">
              <grid-form-input [name]="'Machine Name'" [labelclass]="'display-col'">
                <div class="input-group">
                  <span class="input-group-text">
                    <fa-icon [icon]="faComputer" aria-hidden="true"></fa-icon>
                  </span>
                  <input type='text' id="agentName" class='form-control' formControlName="agentName">
                </div>
              </grid-form-input>
            </div>
            <div class="col">
              <grid-form-input [name]="'Owner'" [labelclass]="'display-col'">
                <div class="input-group">
                  <span class="input-group-text">
                    <fa-icon [icon]="faIdBadge" aria-hidden="true"></fa-icon>
                  </span>
                  <select id="userId" class='form-select' formControlName="userId">
                    <option *ngFor="let u of users" [ngValue]="u._id">{{ u.name }}</option>
                  </select>
                </div>
              </grid-form-input>
            </div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-md-2">
              <grid-form-input [name]="'CPU only'" [labelclass]="'display-col'">
                <div class="form-check form-switch">
                  <input type="checkbox" id="cpuOnly" class="form-check-input" formControlName="cpuOnly">
                </div>
              </grid-form-input>
            </div>
            <div class="col-md-2">
              <grid-form-input [name]="'Trust'" [labelclass]="'display-col'" [tooltip]="'Trust agent with secret data'">
                <div class="form-check form-switch">
                  <input type="checkbox" id="isTrusted" class="form-check-input" formControlName="isTrusted">
                </div>
              </grid-form-input>
            </div>
            <div class="col-md-8">
              <form [formGroup]="assignedTaskForm" (ngSubmit)="onSubmit()">
                <grid-form-input [name]="'Assignment'" [labelclass]="'display-col'">
                  <select type='text' id="assignment" class='form-select' formControlName="taskId">
                    <option [ngValue]="0" *ngIf="hasAssignedTask">Unassigned</option>
                    <option *ngFor="let a of assignTasks" [ngValue]="a.taskId">
                      {{ a.taskId }} - {{ a.taskName }}
                    </option>
                  </select>
                </grid-form-input>
              </form>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <grid-form-input [name]="'Extra parameters'" [labelclass]="'display-col'">
                <input type='text' id="cmdPars" class='form-control' formControlName="cmdPars">
              </grid-form-input>
            </div>
            <div class="col">
              <grid-form-input [name]="'Cracker errors'" [labelclass]="'display-col'">
                <select type='text' id="ignoreErrors" class='form-select' formControlName="ignoreErrors">
                  <option [ngValue]="0">Deactivate agent on error</option>
                  <option [ngValue]="1">Keep agent running, but save errors</option>
                  <option [ngValue]="2">Keep agent running and discard errors</option>
                </select>
              </grid-form-input>
            </div>
          </div>
          <hr>
          <h4 class="display-col">Agent Detailed Information</h4>
          <div class="row">
            <div class="col">
              <grid-form-input [name]="'Machine ID'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg w-70 mx-auto">
                  <td>
                    {{ agent.uid }}
                  </td>
                </span>
              </grid-form-input>
            </div>
            <div class="col">
              <grid-form-input [name]="'Access token'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg w-70 mx-auto">
                  <fa-icon [icon]="faKey" aria-hidden="true"></fa-icon>
                  <td>
                    {{ agent.token }}
                  </td>
                </span>
              </grid-form-input>
            </div>
            <div class="col">
              <grid-form-input [name]="'O.S.'" [labelclass]="'display-col'">
                <span *ngIf="agent.os === 0" class="input-group-text input-group-lg w-15 mx-auto">
                  <fa-icon [icon]="faLinux" aria-hidden="true"></fa-icon>Linux
                </span>
                <span *ngIf="agent.os === 1" class="input-group-text input-group-lg w-15 mx-auto">
                  <fa-icon [icon]="faWindows" aria-hidden="true"></fa-icon>Windows
                </span>
                <span *ngIf="agent.os === 2" class="input-group-text input-group-lg w-15 mx-auto">
                  <fa-icon [icon]="faApple" aria-hidden="true"></fa-icon>IOS
                </span>
              </grid-form-input>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-md-8">
              <grid-form-input [name]="'Graphic cards'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg w-70 mx-auto">
                  <td>
                    {{ agent.devices }}
                  </td>
                </span>
              </grid-form-input>
            </div>
            <div class="col-md-4">
              <grid-form-input [name]="'Member of access groups'" [labelclass]="'display-col'">
                <span class="pre input-group-text input-group-lg">
                  <td>
                    <div *ngFor="let g of agent.accessGroups" style="text-align:left;">
                      <a [routerLink]="['/users/access-groups/',g.accessGroupId,'edit']">{{g.groupName}}</a>
                    </div>
                  </td>
                </span>
              </grid-form-input>
            </div>
          </div>
          <grid-form-input [name]="'Time spent cracking'" [labelclass]="'display-col'" *ngIf="timespent">
            <span class="pre input-group-text input-group-lg">
              <td>
                <div *ngIf="timespent">
                  {{ timespent | sectotime }}
                </div>
              </td>
            </span>
          </grid-form-input>
        </ng-template>
      </ngb-panel>
    </ngb-accordion>
    &nbsp;
    <grid-form-input [name]="'Active'" [labelclass]="'display-col'">
      <div class="form-check form-switch">
        <input type="checkbox" id="isActive" class="form-check-input" formControlName="isActive">
      </div>
    </grid-form-input>
    <div class="row">
      <div class="col">
        <button-submit name="Update" [disabled]="formIsInvalid()"></button-submit>
      </div>
      <div class="col text-end">
        <button-reset label="Reset" (click)="updateForm()"></button-reset>
      </div>
    </div>
  </form>
</grid-main>
<!-- Graphs -->
<app-table>
  <app-page-subtitle [subtitle]="'Device(s) Temperature'"></app-page-subtitle>
  <agent-stat-graph [data]="temperatureData" saveAsName="DeviceTemperature"></agent-stat-graph>
  <app-page-subtitle [subtitle]="'Device(s) Utilization'"></app-page-subtitle>
  <agent-stat-graph [data]="gpuUtilData" saveAsName="DeviceUtilization"></agent-stat-graph>
  <app-page-subtitle [subtitle]="'Agent average CPU utilization'"></app-page-subtitle>
  <agent-stat-graph [data]="cpuUtilData" saveAsName="CPUUtilization"></agent-stat-graph>
</app-table>
<!-- Errors -->
<!-- <app-table>
  <app-page-subtitle [subtitle]="'Error Messages'"></app-page-subtitle>
</app-table> -->
<!-- Dispatched Chunks -->
<app-table>
  <app-page-subtitle subtitle="Dispatched chunks (Latest 50)"></app-page-subtitle>
  <chunks-table [agentId]="agent._id"></chunks-table>
</app-table>